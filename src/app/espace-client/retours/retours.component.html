<div id="rma">
  <mat-tab-group mat-stretch-tabs dynamicHeight animationDuration="0">
    <mat-tab label="Vue par produits">
      <div class="premOnglet">
        <div class=" bandeau2" [ngClass]="{'hidden': windowScrolled}">
          <div class="container-filtres" [ngClass]="{'hidden': windowScrolled}">
            <div class="flex">
              <div class="conteneur action-row">
                <button id="filtresToggle" class="text-button" type="button" (click)="onFiltresTogglePressed($event)"
                        (tap)="onFiltresTogglePressed($event)" [ngClass]="{ active: showFiltres }" appKeyboardFocus>
                  Filtres
                  <i class="icon-caret-down" [ngClass]="{ focused: showFiltres }"></i>
                </button>
                <i title="vider le filtre" class="reset-filter-all" (click)="resetAllFilters()">
                  <mat-icon>clear</mat-icon>
                </i>
              </div>
              <div class="conteneur">
                @if (nbProduitsTemp > 1) {
                  <span class="historique"><b>{{ produitsListTemp.length }}
                    références
                    </b>livrées </span>
                } @else {
                  <ng-container><span class="historique"><b>{{ produitsListTemp.length }} référence </b>livrée
                  </span>
                  </ng-container>
                }
                <mat-form-field [ngStyle]="{width: getWidth()}">
                  <mat-label>Période</mat-label>
                  <mat-select [(value)]="selectedHisto">
                    @for (histo of historiqueList; track histo) {
                      <mat-option [value]="histo"
                                  (click)="filter(histo)">{{ histo }}
                      </mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            </div>

            @if (showFiltres) {
              <ng-container>
                @if (filtres$ | async; as filtres) {
                  <div [formGroup]="filtresForm">
                    <div class="filtresPetit">
                      @for (filtre of filtres; track filtre; let i = $index) {
                        <div class="filtre">
                          <mat-form-field class="taille">
                            <mat-label>{{ filtre.label }}</mat-label>
                            <mat-select [formControlName]="filtre.target" multiple disableOptionCentering
                                        panelClass="select-panel">
                              @for (option of filtre.options; track option; let j = $index) {
                                <mat-option [value]="option"
                                            [disabled]="">
                                  {{ option }}
                                </mat-option>
                              }
                            </mat-select>
                          </mat-form-field>
                          @if (filtresForm.value[filtre.target].length) {
                            <i title="vider le filtre" class="reset-filter"
                               (click)="resetFilters(filtre.target)">
                              <mat-icon>clear</mat-icon>
                            </i>
                          }
                        </div>
                      }

                      <div class="filtre">
                        <mat-form-field>
                          <mat-label>Réf. Produit & Designation</mat-label>
                          <input matInput [ngModel]="filtreRef" (ngModelChange)="rechercheRef($event)"
                                 [ngModelOptions]="{standalone: true}"/>
                        </mat-form-field>
                        @if (filtreRef) {
                          <i title="vider le filtre" class="reset-filter" (click)="resetFiltersRef()">
                            <mat-icon>clear</mat-icon>
                          </i>
                        }
                        <app-tooltip class="iconComp" position="right" type="help" [text]="chargerAideProduitRef()">
                        </app-tooltip>
                      </div>

                      <div class="filtre">
                        <mat-form-field>
                          <mat-label>N° Série</mat-label>
                          <input matInput [ngModel]="filtreNoSerie" (ngModelChange)="rechercheNoSerie($event)"
                                 [ngModelOptions]="{standalone: true}"/>
                        </mat-form-field>
                        @if (filtreNoSerie) {
                          <i title="vider le filtre" class="reset-filter"
                             (click)="resetFiltersSerie()">
                            <mat-icon>clear</mat-icon>
                          </i>
                        }
                        <app-tooltip class="iconComp" position="right" type="help" [text]="chargerAideNoSerie()">
                        </app-tooltip>
                      </div>
                      @if (trouvSerie) {
                        <div class="matError">
                          <span>Votre numéro de série n'a pas été trouvé dans la liste</span>
                        </div>
                      }
                    </div>

                    <!--<div>
                      <mat-form-field>
                        <mat-label>EAN</mat-label>
                        <input matInput [ngModel]="filtreEAN" (ngModelChange)="rechercheEAN($event)" [ngModelOptions]="{standalone: true}"/>
                      </mat-form-field>
                      <app-tooltip class="iconComp" position="right" type="help" [text]="chargerAideEAN()"></app-tooltip>
                    </div> -->
                    @if (filtreMarque) {
                      <div id="marqueTog" class="marque-filtres"
                           [ngClass]="{'hidden': windowScrolled}">
                        @for (option of filtreMarque.options; track option; let j = $index) {
                          <div class="marque-options"
                               [ngClass]="{'selected': filtresForm.get('marque').value.includes(option)}"
                               (click)="filtreMarqueToggle(option)"
                               (tap)="filtreMarqueToggle(option)">
                            <img loading="lazy" class="marque-img"
                                 [src]="environment.logoMarquesCouleurs200x80 + option + '.gif'" [alt]="option">
                          </div>
                        }
                      </div>
                    }
                  </div>
                }

              </ng-container>
            }

          </div>
        </div>

        <!-- RESULTAT & PAGINATOR -->
        <div class="flexB">
          <div class="flexC">
            @if (nbProduitsAffich > 1) {
              <span [appAddClassOnChange]="'flash'"
                    [listenTo]="nbProduitsAffich"><b>{{ produitsListAffich.length }} résultats</b></span>
            } @else {
              <ng-container><span [appAddClassOnChange]="'flash'"
                                  [listenTo]="nbProduitsAffich"><b>{{ produitsListAffich.length }} résultat</b></span>
              </ng-container>
            }
          </div>

          @if (produitsListAffich.length) {
            <mat-paginator
              style-paginator
              [showTotalPages]="3"
              [pageSize]="pageSize"
              [pageIndex]="pageIndex"
              [pageSizeOptions]="pageSizeOptions"
              (page)="pageEvent = getServerData($event)"
              [length]="produitsListAffich.length">
            </mat-paginator>
          }
        </div>

        <div id="band" class="bandeau">
          <ul class="raised-1 size-smaller">
            <li class="grow2 sort" (click)="onTri('Marque')" (tap)="onTri('Marque')">Marque
              <app-tab-sort
                [state]="selected('Marque')"></app-tab-sort>
            </li>
            <li class="grow2 sort" (click)="onTri('Réf. produit')" (tap)="onTri('Réf. produit')">Réf. produit
              <app-tab-sort
                [state]="selected('Réf. produit')"></app-tab-sort>
            </li>
            <li class="grow3">Désignation</li>
            <li class="grow2 sort" (click)="onTri('N° de BL')" (tap)="onTri('N° de BL')">N° de BL
              <app-tab-sort
                [state]="selected('N° de BL')"></app-tab-sort>
            </li>
            <li class="grow3">N° de série</li>
            <li class="grow2 sort" (click)="onTri('Fin de garantie')" (tap)="onTri('Fin de garantie')">Fin de garantie
              <app-tab-sort
                [state]="selected('Fin de garantie')"></app-tab-sort>
            </li>
            <li class="grow1C">Qte</li>
            <li class="grow1C">Sélection</li>
            <li class="deselect" (click)="deselectionner()">Tout déselectioner</li>
          </ul>
        </div>

        <div class="background">
          @for (
            produit of produitsListAffich.slice(pageIndex * pageSize, (pageIndex + 1) * pageSize); track produit; let
            i = $index) {
            <ng-container class="detailsProduits">
              @if (produit.noserie && produit.quantite > 1) {
                <ng-container>
                  <div class="margeProduits">
                    <div class="cadreProduits">
                      @for (noserie of produit.noserie; track noserie; let j = $index) {
                        <ng-container>
                          <span id="{{i}}:{{j}}" class="produitsRMA">
                            <label class="grow2">{{ produit.marque }}</label>
                            <label class="grow2">{{ produit.produit }}</label>
                            <label class="grow3">{{ produit.designation }}</label>
                            @if (produit.datebl) {
                              <label class="grow2">{{ produit.numbl }} du
                                {{ produit.datebl }}</label>
                            } @else {
                              <ng-container>
                                <label class="grow2">{{ produit.numbl }}</label>
                              </ng-container>
                            }
                            <label class="grow3">
                              <!-- Cas où noserie est vide -->
                              @if (noserie && noserie.trim() !== '') {
                                <ng-container>
                                {{ start(noserie) }}
                                  @if (noserie.includes(filtreNoSerie.toUpperCase())) {
                                    <span style="font-weight: bold;">
                                      {{ filtreNoSerie.toUpperCase() }}
                                    </span>
                                  }
                                  {{ end(noserie) }}
                              </ng-container>
                              } @else {
                                <ng-container>
                                NC
                              </ng-container>
                              }
                            </label>

                            <label class="grow2">{{ produit.garantiedatefin }}</label>
                            <label class="grow1C">1</label>
                            <div class="grow1C">
                              @if (valideRMA(produit) && !disableList[i]) {
                                <mat-checkbox [disabled]="disableList[i]"
                                              [checked]="checkList[i]"
                                              (click)="selectionner2(i, noserie)"></mat-checkbox>
                              }
                              @if (!valideRMA(produit)) {
                                <app-tooltip class="iconComp" position="right" type="error"
                                             [text]="chargerAideProduitRef()"></app-tooltip>
                              }
                            </div>
                            <label class="grow2">
                              @if (numberList[i] && noserie === noserieActive) {
                                <button class="raised-button"
                                        type="button"
                                        (click)="selectProduit(produit)">{{ textBtn }}</button>
                              }
                            </label>
                          </span>

                        </ng-container>
                      }
                      <div class="details" [ngClass]="{'show': cadreDetails[i]}">
                        <label class="labelDetB">Réf. client : </label>
                        <label class="labelDet">{{ produit.referencecommande }}</label>
                        <label class="labelDetB">Réf. ACTN : </label>
                        <label class="labelDet">{{ produit.numcommande }}</label>
                        @if (produit.numfacture && produit.datefacture) {
                          <label class="labelDetB">N° de facture
                            : </label>
                        }
                        @if (produit.numfacture && produit.datefacture) {
                          <label class="labelDet">
                            {{ produit.numfacture }} du {{ produit.datefacture }}
                          </label>
                        }
                      </div>
                    </div>
                    <div class="popDetails" (click)="montrerDetails(i)">
                      @if (!cadreDetails[i]) {
                        <i class="unroll-button icon-plus flat-button"></i>
                      } @else {
                        <ng-container>
                          <i class="unroll-button icon-minus flat-button"></i>
                        </ng-container>
                      }
                      de détails
                    </div>
                  </div>
                </ng-container>
              } @else {
                <ng-container>
                  <div class="margeProduits">
                    <div class="cadreProduits">
                    <span id="{{i}}:0" class="produitsRMA">
                      <label class="grow2">{{ produit.marque }}</label>
                      <label class="grow2">{{ produit.produit }}</label>
                      <label class="grow3">{{ produit.designation }}</label>
                      @if (produit.datebl) {
                        <label class="grow2">{{ produit.numbl }} du
                          {{ produit.datebl }}</label>
                      } @else {
                        <ng-container>
                          <label class="grow2">{{ produit.numbl }}</label>
                        </ng-container>
                      }
                      <label class="grow3">
    @if (produit.noserie && produit.noserie.trim() !== '') {
      <ng-container>
        {{ start(produit.noserie) }}
        @if (produit.noserie.includes(filtreNoSerie.toUpperCase())) {
          <span style="font-weight: bold;">
            {{ filtreNoSerie.toUpperCase() }}
          </span>
        }
        {{ end(produit.noserie) }}
      </ng-container>
    } @else {
      <ng-container>
        NC
      </ng-container>
    }
  </label>

                      <label class="grow2">{{ produit.garantiedatefin }}</label>
                      <label class="grow1C">{{ produit.quantite }}</label>
                      <div class="grow1C">
                        @if (valideRMA(produit) && !disableList[i]) {
                          <mat-checkbox [disabled]="disableList[i]"
                                        [checked]="checkList[i]"
                                        (click)="selectionner(i, produit.quantite)"></mat-checkbox>
                        }
                        @if (!valideRMA(produit)) {
                          <app-tooltip class="iconComp" position="right" type="error"
                                       [text]="chargerAideProduitNonValide()"></app-tooltip>
                        }
                      </div>
                      <label class="grow2">
                        <div class="marginClass">
                          @if (produit.quantite > 1 && numberList[i]) {
                            <app-input-number min="1"
                                              max={{produit.quantite}}
                                              [number]="quant" (value)="quantChange($event)" size="small">
                            </app-input-number>
                          }
                        </div>
                        @if (numberList[i] && quant > 1) {
                          <button class="raised-button" type="button"
                                  (click)="selectProduit(produit)">Retourner les produits</button>
                        }
                        @if ((numberList[i] && +produit.quantite === 1) || (numberList[i] && quant === 1)) {
                          <button class="raised-button" type="button" (click)="selectProduit(produit)">
                            Retourner le produit
                          </button>
                        }
                      </label>
                    </span>
                      <div class="details" [ngClass]="{'show': cadreDetails[i]}">
                        <label class="labelDetB">Réf. client : </label>
                        <label class="labelDet">{{ produit.referencecommande }}</label>
                        <label class="labelDetB">Réf. ACTN : </label>
                        <label class="labelDet">{{ produit.numcommande }}</label>
                        @if (produit.numfacture && produit.datefacture) {
                          <label class="labelDetB">
                            N° de facture :
                          </label>
                        }
                        @if (produit.numfacture && produit.datefacture) {
                          <label class="labelDet">
                            {{ produit.numfacture }} du {{ produit.datefacture }}
                          </label>
                        }
                      </div>
                    </div>
                    <div class="popDetails" (click)="montrerDetails(i)">
                      @if (!cadreDetails[i]) {
                        <i class="unroll-button icon-plus flat-button"></i>
                      } @else {
                        <ng-container>
                          <i class="unroll-button icon-minus flat-button"></i>
                        </ng-container>
                      }
                      &nbsp;de détails
                    </div>
                  </div>
                </ng-container>
              }
            </ng-container>
          }
        </div>

        <div class="flexB">
          <div class="flexC">
            <h4>Si vous ne trouvez pas votre produit, pensez à utiliser les filtres.</h4>
          </div>

          @if (produitsListAffich.length) {
            <mat-paginator
              style-paginator
              [showTotalPages]="3"
              [pageSize]="pageSize"
              [pageIndex]="pageIndex"
              [pageSizeOptions]="pageSizeOptions"
              (page)="pageEvent = getServerData($event)"
              [length]="produitsListAffich.length">
            </mat-paginator>
          }
        </div>

        <h4 class="link">Seul s'affichent les produits ouverts au droit de retour (voir <a
          [routerLink]="['/conditions-generales-de-vente']" fragment="7" href="">Conditions Générales de Vente</a>) ou
          couverts par une garantie.
        </h4>


      </div>
    </mat-tab>
    <mat-tab label="Vue par commandes">
      <div class="secOnglet">
        <app-commandes></app-commandes>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
