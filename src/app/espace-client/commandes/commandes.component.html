<div class="container-filtres raised-1">
  <button class="text-button">Filtres</button>
  <button class="raised-button" [routerLink]="['/espace-client', 'reliquats']">Suivre des reliquats de
    commande
  </button>
  <div class="filtres">
    <div class="filtre">
      <mat-form-field>
        <mat-label>Réf. client</mat-label>
        <input matInput [ngModel]="filtres.get('referencecommande')"
               (ngModelChange)="onSearch('referencecommande', $event)"/>
      </mat-form-field>
    </div>
    <div class="filtre">
      <mat-form-field>
        <mat-label>N° de commande</mat-label>
        <input matInput [ngModel]="filtres.get('numcommande')"
               (ngModelChange)="onSearch('numcommande', $event)"/>
      </mat-form-field>
    </div>
    <div class="filtre">
      <mat-form-field>
        <mat-label>Réf. produit</mat-label>
        <input matInput [ngModel]="filtres.get('ref-produit')" (ngModelChange)="onSearch('produit', $event)"/>
      </mat-form-field>
    </div>
    <div class="filtre">
      <mat-form-field>
        <mat-label>N° de BL</mat-label>
        <input matInput [ngModel]="filtres.get('numbl')" (ngModelChange)="onSearch('numbl', $event)"/>
      </mat-form-field>
    </div>
    <div class="filtre">
      <mat-form-field>
        <mat-label>N° de Facture</mat-label>
        <input matInput [ngModel]="filtres.get('numfacture')"
               (ngModelChange)="onSearch('numfacture', $event)"/>
      </mat-form-field>
    </div>
    <div class="filtre filtreBox">
      <mat-form-field>
        <mat-label>Statut</mat-label>
        <mat-select [ngModel]="filtres.get('statut')" (ngModelChange)="onSearch('statut', $event)">
          @for (statut of statutSet; track statut) {
            <mat-option [value]="statut">{{ statut }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      @if (filtres.has('statut') && filtres.get('statut').length > 0) {
        <ng-container>
          <i
            class="CANESELAVEPAS"
            title="vider le filtre"
            (click)="resetFilterMarque('statut')"
          >
            <mat-icon>clear</mat-icon>
          </i>
        </ng-container>
      }
    </div>
    <div class="filtre filtreBox">
      <mat-form-field>
        <mat-label>Marque</mat-label>
        <mat-select [ngModel]="filtres.get('marque')" (ngModelChange)="onSearch('marque', $event)" multiple>
          @for (marque of marqueArray; track marque) {
            <mat-option [value]="marque">{{ marque }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      @if (filtres.has('marque') && filtres.get('marque').length > 0) {
        <ng-container>
          <i
            class="CANESELAVEPAS"
            title="vider le filtre"
            (click)="resetFilterMarque('marque')"
          >
            <mat-icon>clear</mat-icon>
          </i>
        </ng-container>
      }
    </div>
  </div>
  @if (marqueArray) {
    <div class="marque-filtres">
      @for (option of marqueArray; track option; let j = $index) {
        <div class="marque-options" [ngClass]="{'selected': filtres.get('marque').includes(option)}"
             (click)="filtreMarqueToggle(option)"
             (tap)="filtreMarqueToggle(option)">
          <img loading="lazy" class="marque-img" [src]="environment.logoMarquesCouleurs200x80 + option + '.gif'"
               [alt]="option"/>
        </div>
      }
    </div>
  }
</div>

<!-- PAGINATOR -->
<mat-paginator class="bandeau" [length]="formatCmd.length" [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions"
               (page)="pageEvent = getServerData($event)">
</mat-paginator>

<!-- LABELS -->
<div class="bandeau">
  <ul class="raised-1 size-smaller display-flex borderRadius">
    <li class="grow-ref sort" (click)="onTri('Réf. client')" (tap)="onTri('Réf. client')">Réf. client
      <app-tab-sort
        [state]="selected('Réf. client')"></app-tab-sort>
    </li>
    <li class="grow sort" (click)="onTri('Réf. ACTN')" (tap)="onTri('Réf. ACTN')">N° de commande
      <app-tab-sort
        [state]="selected('Réf. ACTN')"></app-tab-sort>
    </li>
    <li class="grow sort" (click)="onTri('Date')" (tap)="onTri('Date')">Date
      <app-tab-sort
        [state]="selected('Date')"></app-tab-sort>
    </li>
    <li class="grow sort del-for-phone" (click)="onTri('Factures')" (tap)="onTri('Factures')">Factures
      <app-tab-sort
        [state]="selected('Factures')"></app-tab-sort>
    </li>
    <li class="grow sort del-for-phone" (click)="onTri('Dates Fact.')" (tap)="onTri('Dates Fact.')">Dates Fact.
      <app-tab-sort
        [state]="selected('Dates Fact.')"></app-tab-sort>
    </li>
    <li class="grow sort del-for-phone" (click)="onTri('Statut')" (tap)="onTri('Statut')">Statut
      <app-tab-sort
        [state]="selected('Statut')"></app-tab-sort>
    </li>
  </ul>
</div>

<!-- COMMANDES -->
@if (!loading && formatCmd.length == 0) {
  <div class="no-result"> Vous n'avez pas d'historique de commandes</div>
}
<!-- NGFOR - NUM DE COMMANDES -->
@if (cmdDetails) {
  <div class="licences">
    @for (livraisons of formatCmd.slice(pageIndex * pageSize, (pageIndex + 1) * pageSize); track livraisons; let
      i = $index; ) {
      <div class="licence size-smaller">
        <div class="raised-1">
          <!-- LIVRAISONS ENTETE -->
          <div (click)="unrollCommandDetails(livraisons);" class="entete size-default">

            @for (livraison of livraisons; track livraison; let j = $index) {
              <div class="commande"
                   [ngClass]="{'del-for-phone': j > 0}">
                @if (j == 0) {
                  <div class="display-flex">
                    <label hidden>Réf. client</label>
                    <div class="refClient grow-ref">{{ livraison.referencecommande }}</div>

                    <label hidden>Réf. ACTN</label>
                    @if (!livraison.pdfar) {
                      <div class="refACTN grow">{{ livraison.numcommande }}
                      </div>
                    } @else {
                      <ng-container>
                        <a class="refACTN grow arpdflink"
                           target="_blank"
                           [href]="environment.apiUrl + '/document/generate.php?document=' + livraison.numcommande + '&type=AR'">
                          {{ livraison.numcommande }}
                          <fa-icon [icon]="faFilePdf"></fa-icon>
                        </a>
                      </ng-container>
                    }
                    <label hidden>Date</label>
                    <div class="date grow">{{ livraison.datecommande | date:'dd/MM/yyyy' }}</div>

                    <label hidden>Factures</label>
                    <div class="refACTN grow del-for-phone">
                      @if (livraison.numfacture != 0) {
                        <ng-container>
                          @if (livraison.pdffacture) {
                            <ng-container>
                              <a class="underline"
                                 [href]="environment.apiUrl + '/document/generate.php?document=' + livraison.numfacture + '&type=FACTURE'"
                                 target="_blank"
                              >
                                {{ livraison.numfacture }}
                                <fa-icon [icon]="faFilePdf"></fa-icon>
                              </a>
                            </ng-container>
                          } @else {
                            <ng-container>
                              {{ livraison.numfacture }}
                              <span class="size-small no-wrap">
                                  <!-- <fa-icon [icon]="['fas', 'file-pdf']"></fa-icon> -->
                                  <br/>
                                  PDF indisponible
                                  <app-tooltip type="help"
                                               [text]="explicationPDFFactureindispo"></app-tooltip>
                              </span>
                            </ng-container>
                          }
                        </ng-container>
                      } @else {
                        <ng-container>
                          <div class="grow del-for-phone">n.c.</div>
                        </ng-container>
                      }
                    </div>

                    <div class="del-for-phone">
                      <label hidden>Date Fact.</label>
                      @if (livraison.datefacture != '2000-00-00') {
                        <div class="refACTN grow">
                          {{ livraison.datefacture | date: 'dd/MM/yyyy' }}
                        </div>
                      } @else {
                        <ng-container>
                          <div class="grow">n.c.</div>
                        </ng-container>
                      }
                    </div>

                    <label hidden>Statut</label>
                    @if (statutCmd[livraison.numcommande] != 'Reliquat livraison') {
                      <div
                        class="statut grow">{{ statutCmd[livraison.numcommande] }}
                      </div>
                    } @else {
                      <ng-container>
                        <a class="statut grow" routerLink="../reliquats">
                          <div class="reliquat-link">
                            {{ statutCmd[livraison.numcommande] }}
                          </div>
                        </a>
                      </ng-container>
                    }
                  </div>
                } @else {
                  <ng-container>
                    <div class="display-flex del-for-phone">
                      <div class="grow-ref del-for-phone">&nbsp;</div>
                      <div class="grow del-for-phone">&nbsp;</div>
                      <div class="grow del-for-phone">&nbsp;</div>
                      <div class="grow del-for-phone">
                        @if (livraison.numfacture != 0) {
                          <ng-container>
                            @if (livraison.pdffacture) {
                              <ng-container>
                                <a class="underline"
                                   [href]="environment.apiUrl + '/document/generate.php?document=' + livraison.numfacture + '&type=FACTURE'"
                                   target="_blank"
                                >
                                  {{ livraison.numfacture }}
                                  <fa-icon [icon]="faFilePdf"></fa-icon>
                                </a>
                              </ng-container>
                            } @else {
                              <ng-container>
                                {{ livraison.numfacture }}
                                <!-- <fa-icon [icon]="['fas', 'file-pdf']"></fa-icon> -->
                                <br/>
                                <span class="size-small no-wrap">
                                    PDF indisponible
                                    <app-tooltip type="help"
                                                 [text]="explicationPDFFactureindispo"></app-tooltip>
                                </span>
                              </ng-container>
                            }
                          </ng-container>
                        } @else {
                          <ng-container>
                            <div class="grow del-for-phone">n.c.</div>
                          </ng-container>
                        }
                      </div>
                      <div class="grow del-for-phone">{{ livraison.datefacture | date: 'dd/MM/yyyy' }}</div>
                      <div class="grow del-for-phone">&nbsp;</div>
                    </div>
                  </ng-container>
                }
              </div>
            }
          </div>

          <!-- LIVRAISONS DETAILS -->
          <div class="details bgwhite commandeDetails" [ngClass]="{'show': display[livraisons[0].numcommande]}">
            <ng-container>

              <hr>
              <!-- ADRESSE -->
              <span class="weight-bolder">Adresse de Livraison</span>
              <div class="adresses">
                <span class="weight-bolder">{{ livraisons[0].wnom }}</span>
                <br>
                <span>{{ livraisons[0].wadresse1 }}&nbsp;&nbsp;</span>
                <br>
                @if (livraisons[0].wadresse2) {
                  <span>{{ livraisons[0].wadresse2 }}&nbsp;&nbsp;<br></span>
                }
                <span>{{ livraisons[0].wcodepostal }}&nbsp;&nbsp;</span>
                <span>{{ livraisons[0].wville }}</span>
                <br>
                <span>{{ (livraisons[0].pays ? livraisons[0].pays : "France") }}</span>
                <br>
                <!-- <span>{{ livraisons[0].adresse1 }} <br> {{ livraisons[0].adresse2 }} <br> {{ livraisons[0].adresse3 }} <br> {{ livraisons[0].adresse4 }}</span> -->
              </div>

              <!-- NGFOR - BON DE COMMANDE / BL -->
              @for (livraison of livraisons; track livraison; let livraisonIndex = $index) {
                <div>
                  <hr>
                  <!-- CMD DETAILS -->
                  <span class="labels_details detail-grid weight-bolder">
                  <label>BL</label>
                    @if (livraison.statut == 'Avoir') {
                      <label>Avoir</label>
                    } @else {
                      <label>Facture</label>
                    }
                    <label>Suivi de livraison</label>
                    <label>Statut</label>
                </span>

                  <div class="detail-grid test1">
                    <!-- IF BL !0 -->
                    <div>
                      @if (!(livraison.numbl == 0)) {
                        <div class="blID">
                          @if (livraison.pdfbl) {
                            <ng-container>
                              <a
                                [href]="environment.apiUrl + '/document/generate.php?document=' + livraison.numbl + '&type=BON'"
                                target="_blank"
                                class="underline"
                              >
                                <label hidden>BL n°</label>
                                <span>{{ livraison.numbl }}&nbsp;</span>
                                <span>du {{ livraison.datebl | date: 'dd/MM/yyyy' }}&nbsp;</span>
                                <fa-icon [ngClass]="{ unavailable: livraison.numbl === livraison.numfacture }"
                                         [icon]="faFilePdf">
                                </fa-icon>
                              </a>
                            </ng-container>
                          } @else {
                            <ng-container>
                              <label hidden>BL n°</label>
                              <span>{{ livraison.numbl }}&nbsp;</span>
                              <span>du {{ livraison.datebl | date: 'dd/MM/yyyy' }}&nbsp;</span>
                              <!-- <fa-icon [icon]="['fas', 'file-pdf']"></fa-icon> -->
                              <br/>
                              <span class="size-small no-wrap no-pdf">
                                                  PDF indisponible
                                                  <app-tooltip type="help"
                                                               [text]="explicationPDFBLindispo"></app-tooltip>
                                              </span>
                            </ng-container>
                          }
                        </div>
                      } @else {
                        <!-- IF BL 0 -->
                        <ng-container><span style="font-style: italic;">En attente de traitement</span>
                        </ng-container>
                      }
                    </div>

                    <!-- IF facture !0 -->
                    <div>
                      @if (!(livraison.numfacture == 0)) {
                        <div class="factID">
                          @if (livraison.pdffacture) {
                            <ng-container>
                              <a
                                [href]="environment.apiUrl + '/document/generate.php?document=' + livraison.numfacture + '&type=FACTURE'"
                                target="_blank"
                                class="underline">
                                <label hidden>Facture n°</label>
                                <span>{{ livraison.numfacture }}&nbsp;</span>
                                <span>du {{ livraison.datefacture | date: 'dd/MM/yyyy' }}&nbsp;</span>
                                <fa-icon [icon]="faFilePdf"></fa-icon>
                              </a>
                            </ng-container>
                          } @else {
                            <ng-container>
                              <label hidden>Facture n°</label>
                              <span>{{ livraison.numfacture }}&nbsp;</span>
                              <span>du {{ livraison.datefacture | date: 'dd/MM/yyyy' }}&nbsp;</span>
                              <!-- <fa-icon [icon]="['fas', 'file-pdf']"></fa-icon> -->
                              <br/>
                              <span class="size-small no-wrap no-pdf">
                                                  PDF indisponible
                                                  <app-tooltip type="help"
                                                               [text]="explicationPDFFactureindispo"></app-tooltip>
                                              </span>
                            </ng-container>
                          }
                        </div>
                      } @else {
                        <!-- IF facture 0 -->
                        <ng-container><span style="font-style: italic;">En attente de traitement</span>
                        </ng-container>
                      }
                    </div>

                    <!-- Num Colis -->
                    <div>
                      @if (sortedNumColis.get(livraison.numcommande)) {
                        <div>
                          @if (sortedNumColis.get(livraison.numcommande).get(livraison.numbl)) {
                            <div>
                              @for (
                                colis of sortedNumColis.get(livraison.numcommande).get(livraison.numbl); track colis; let
                                j = $index) {
                                <div>
                                  <a title="Suivre votre colis"
                                     class="numColis underline"
                                     href="{{ sortedNumColis.get(livraison.numcommande).get(livraison.numbl)[j].urlcolis }}"
                                     target="_blank">
                                    {{ sortedNumColis.get(livraison.numcommande).get(livraison.numbl)[j].numccolis }}
                                    <fa-icon [icon]="faTruck"></fa-icon>
                                    @if (livraison.transporteur) {
                                      <ng-container>
                                        <br><span
                                        class="size-small no-pdf transporteur">{{ livraison.transporteur }}</span>
                                      </ng-container>
                                    } @else {

                                    }
                                  </a>
                                </div>
                              }

                            </div>
                          } @else {
                            <ng-container>
                              <span style="font-style: italic;">Indisponible</span>
                              @if (livraison.transporteur) {
                                <ng-container>
                                  <br><span class="size-small no-pdf transporteur">{{ livraison.transporteur }}</span>
                                </ng-container>
                              }
                            </ng-container>
                          }
                        </div>
                      } @else {
                        <ng-container>
                          <span style="font-style: italic;">Indisponible</span>
                          @if (livraison.transporteur) {
                            <ng-container>
                              <br><span class="size-small no-pdf transporteur">{{ livraison.transporteur }}</span>
                            </ng-container>
                          }
                        </ng-container>
                      }
                    </div>

                    <!-- Status -->
                    <div>
                      <span>{{ livraison.statut }}</span>
                    </div>
                  </div>

                  <!-- NUMEROS DE COLIS -->
                  <div>
                    @if (sortedNumColis[livraison.numcommande]) {
                      <div>
                        @if (sortedNumColis[livraison.numcommande][livraison.numbl]) {
                          <div>
                            @for (colis of sortedNumColis[livraison.numcommande][livraison.numbl]; track colis; let
                              j = $index) {
                              <div>
                                @if (j != 0) {
                                  <div class="details detail-grid">
                                    <!-- <div>
                                        {{ j }}
                                    </div>-->
                                    <div><a class="numColis underline" href="{{ colis.urlcolis }}"
                                            target="_blank">
                                      {{ colis.numccolis }}
                                    </a>
                                    </div>
                                  </div>
                                }
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>

                  <br>

                  <!-- Produits  ici-->
                  <span class="labels_produits detail-grid2 weight-bolder">

                                <label>Marque</label>
                                <label>Produit</label>
                                <label class="designation">Désignation</label>
                                <label class="quantite">Quantité</label>
                            </span>
                  @for (produit of getDetailsFromCommande(livraison.numcommande, livraison.numbl); track produit) {
                    <div class="produits">
                      <div class="produit detail-grid2 weight-bold">

                        <span>{{ produit.marque }}</span>
                        <div class="panier">
                          <a class="produitLink" (click)="linkToProduct(produit.produit)">{{ produit.produit }}</a>
                          <app-tooltip (click)="addProduitToCart(produit)"
                                       class="cartLogo" showDelay="100" text="Ajouter le produit au panier"
                                       type="cart"></app-tooltip>
                        </div>
                        <span class="designation-produit">{{ produit.designation }}</span>
                        <span class="quantite">{{ produit.quantite }}</span>
                        @if (page === 'rma' && listOK) {
                          <ng-container>
                            @if (isValid(produit)) {
                              <button class="raised-button addBtn"
                                      type="button" (click)="popupDisplay(produit)">Retourner le produit
                              </button>
                            } @else {
                              <ng-container>
                                <div class="display-flex">
                                  <button class="raised-button addBtn disabled" type="button"
                                          [disabled]="true">Retourner le produit
                                  </button>
                                  <app-tooltip class="iconComp" position="right" type="error"
                                               [text]="chargerAideProduitNonValide()"></app-tooltip>
                                </div>
                              </ng-container>
                            }
                          </ng-container>
                        }
                      </div>
                      <!-- S/N -->
                      <br/>
                      @if (livraisonSerials(livraison).length > 0) {
                        <div class="serial-numbers">
                          @if (produitSerials(livraisonSerials(livraison), produit).length > 0) {
                            <div class="noserie">
                              <span class="weight-bolder">S/N:&nbsp;</span>
                              @for (serial of produitSerials(livraisonSerials(livraison), produit); track serial; let
                                k = $index) {
                                <span>
                                    @if (serial.produit == produit.produit) {
                                      <span>
                                          @if (k > 0) {
                                            <span>&nbsp;,&nbsp;</span>
                                          }
                                        <span>
                                              {{ serial.SERIE }}
                                          </span>
                                      </span>
                                    }
                                </span>
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  }
                </div>
              }

            </ng-container>
          </div>
        </div>

        <div class="button-displayer">

          <div class="bouton-details left" (click)="unrollCommandDetails(livraisons);">
            @if (!display[livraisons[0].numcommande]) {
              <fa-icon class="prefix icon size-big"
                       [icon]="faPlusCircle"></fa-icon>
            } @else {
              <ng-container>
                <fa-icon class="prefix icon size-big" [icon]="faMinusCircle"></fa-icon>
              </ng-container>
            }
            <span class="texte" style="font-size: 1rem;">de détails</span>
          </div>

          <div class="bouton-details right" (click)="reOrderPreviousCommand(livraisons);">
            <i class="icon-share icon-cart">
            </i>
            <span class="texte" style="font-size: 1rem;">recommander</span>
          </div>
        </div>

      </div>
    }
  </div>
}

@if (produitActif) {
  <ng-container>
    <div [ngClass]="isPopUp ? 'popUpActive' : 'popUpInactive'">
          <span class="labelsRMACom">
              <label class="grow2">Marque</label>
              <label class="grow2">Réf. produit</label>
              <label class="grow3">Désignation</label>
              <label class="grow2">Fin de garantie</label>
          </span>
      <span class="produitsRMACom">
              <label class="grow2">{{ produitActif.marque }}</label>
              <label class="grow2">{{ produitActif.produit }}</label>
              <label class="grow3">{{ produitActif.designation }}</label>
              <label class="grow2">{{ produitActif.garantiedatefin }}</label>
          </span>
      @if (produitActif.noserie) {
        <div>
          <div class="margeCom">
            <h3>Quels produits voulez vous retourner ?</h3>
          </div>
          <div class="listSerie">
            @for (noserie of produitActif.noserie; track noserie) {
              <ng-container>
                <div class="noSerie">
                  <mat-checkbox (click)="selectionSerie(noserie)"></mat-checkbox>
                  &nbsp;&nbsp;&nbsp;{{ noserie }}
                </div>
              </ng-container>
            }
          </div>
          <div class="display-flex">
            <div class="debfin">
              <button class="raised-button btnSec" type="button" (click)="close()">Retour</button>
            </div>
            <div class="dumb2"></div>
            <div class="debfin">
              <button class="raised-button" type="button" (click)="selectProduit(produitActif)">Valider</button>
            </div>
          </div>
        </div>
      } @else {
        <ng-container>
          <div>
            <div class="margeCom">
              <h3>Combien de produits voulez vous retourner ?</h3>
            </div>
            <span class="produitsRMACom">
                      <label class="grow1">
                          <div class="display-flex">
                              <label class="center">Quantité :</label>
                              <div class="marginClasse">
                                  <app-input-number min="1" max={{produitActif.quantite}} [number]="quant"
                                                    (value)="quantChange($event)" size="small">
                                  </app-input-number>
                              </div>
                          </div>
                      </label>
                  </span>
            <div class="display-flex">
              <div class="debfin">
                <button class="raised-button addBtn btnSec" type="button" (click)="close()">Retour</button>
              </div>
              <div class="dumb2"></div>
              <div class="debfin">
                <button class="raised-button addBtn" type="button"
                        (click)="selectProduit(produitActif, true)">Valider
                </button>
              </div>
            </div>
          </div>
        </ng-container>
      }
    </div>
  </ng-container>
}
<div class="dark-overlay" [ngClass]="{ show: isPopUp }" (click)="close()"></div>
<app-popup-obj-display></app-popup-obj-display>
